(function(){'use strict';var p='アプリID';var q='出力結果';var r='\t';var s='\r\n';var u='@@@';var w={"&":"&amp;","'":"&#x27;","`":"&#x60;","\"":"&quot;","<":"&lt;",">":"&gt;"};var x=function(b){return b.replace(/[&"'`\\<>]/g,function(a){return w[a]})};var y=function(c){var d="<table id=\"table\">\n";var e=c[0].split("\t");d=d+"<thead><tr class=\"header-row row\">\n";for(var m=0;m<e.length;m++){d=d+"<th class=\"cell\">"+x(e[m])+"</th>\n"}d=d+"</tr></thead>\n";d=d+"<tbody>\n";for(var i=1;i<c.length;i++){var f=c[i].split("\t");d=d+"<tr class=\"row\">\n";for(var m=0;m<f.length;m++){d=d+"<td class=\"body-cell cell\">\n"+(function(b){if(!/\@\@\@/.test(b)){return x(b)}return"<ul style=\"list-style:none;padding:0px;\">"+b.split("@@@").map(function(a){return"<li>"+x(a)+"</li>\n"}).join("")+"</ul>\n"})(f[m])+"</td>\n"}d=d+"</tr>\n"}d=d+"</tbody>\n"+"</table>\n";return d};var z=function(a){var b=a.split("\n");var c=y(b);return"<html>\n"+"<head>\n"+"<meta charset=\"utf-8\">\n"+"<link\n"+"href=\"https://rawgit.com/TakahiroTai/TaitanLab/master/TaitanLab/2017/form_output.css\"\n"+"rel=\"stylesheet\"\n"+"crossorigin=\"anonymous\">\n"+"</head>\n"+"<body>\n"+"<div class=\"caption\">"+"設計情報"+"</div>\n"+c+"</body>\n"+"</html>"};function exportHTML(a){var b=z(a);var c=new File([b],"設計情報.html",{type:"text/html"});var d=URL.createObjectURL(c);window.open(d)}function getFieldData4(c,d){var e=d?'[TABLE]'+c.type:c.type;var f=c.required?"必須":"";var g=c.unique?"重複禁止":"";var h=(function(){var v=[];for(var i in c.options){if(!c.options.hasOwnProperty(i)){continue}var a=c.options[i];var b=parseInt(a.index,10);v[b]=a.label}return v.join(u)})(c);return[c.label,c.code,e,h,f,g].join(r)}function getFieldData3(b,c){var d=c?'[TABLE]'+b.type:b.type;var e=b.required?"必須":"";var f=b.unique?"重複禁止":"";var g=(function(){var v=[];for(var i in b.options){if(!b.options.hasOwnProperty(i)){continue}var a=b.options[i];v.push(a.label)}return v.join(u)})(b);return[b.label,b.code,d,g,e,f].join(r)}function getFieldData2(b,c){var d=c?'[TABLE]LOOKUP_'+b.type:'LOOKUP_'+b.type;var e=(function(){var v=['***ルックアップ時のコピー先フィールド***'];var a=b.lookup.fieldMappings;for(var i in a){if(!a.hasOwnProperty(i)){continue}v.push(a[i].field)}return v.join(u)})(b);var f=b.required?"必須":"";var g=b.unique?"重複禁止":"";return[b.label,b.code,d,e,f,g].join(r)}function getFieldData1(a,b){var c=a.label?a.label:"";var d=b?'[TABLE]'+a.type:a.type;var e=a.required?"必須":"";var f=a.unique?"重複禁止":"";return[c,a.code,d,'',e,f].join(r)}function table2Csv(a,b){var c=[];for(var i in a.fields){if(!a.fields.hasOwnProperty(i)){continue}var d=a.fields[i];switch(d.type){case'SINGLE_LINE_TEXT':case'NUMBER':if(!d.lookup){c[b[d.code]]=getFieldData1(d,true)}else{c[b[d.code]]=getFieldData2(d,true)}break;case'RECORD_NUMBER':case'__ID__':case'__REVISION__':case'CREATOR':case'CREATED_TIME':case'MODIFIER':case'UPDATED_TIME':case'CALC':case'MULTI_LINE_TEXT':case'RICH_TEXT':case'FILE':case'LINK':case'DATE':case'TIME':case'DATETIME':case'USER_SELECT':case'STATUS_ASSIGNEE':case'ORGANIZATION_SELECT':case'GROUP_SELECT':c[b[d.code]]=getFieldData1(d,true);break;case'REFERENCE_TABLE':break;case'CHECK_BOX':case'DROP_DOWN':case'RADIO_BUTTON':case'MULTI_SELECT':c[b[d.code]]=getFieldData4(d,true);break;default:break}}return c}function json2Csv(a,b){var c=["表示名"+r+"フィールドコード"+r+"フィールドタイプ"+r+"選択肢"+r+"必須"+r+"重複"];var d=[];for(var i in a.properties){if(!a.properties.hasOwnProperty(i)){continue}var e=a.properties[i];switch(e.type){case'SUBTABLE':var f=table2Csv(e,b);for(var t in f){c[parseInt(t,10)]=f[t]}break;case'SINGLE_LINE_TEXT':case'NUMBER':if(!e.lookup){c[b[e.code]]=getFieldData1(e)}else{c[b[e.code]]=getFieldData2(e)}break;case'RECORD_NUMBER':case'__ID__':case'__REVISION__':case'CREATOR':case'CREATED_TIME':case'MODIFIER':case'UPDATED_TIME':case'CALC':case'MULTI_LINE_TEXT':case'RICH_TEXT':case'FILE':case'LINK':case'DATE':case'TIME':case'DATETIME':case'USER_SELECT':case'STATUS_ASSIGNEE':case'ORGANIZATION_SELECT':case'GROUP_SELECT':if(b[e.code]){c[b[e.code]]=getFieldData1(e)}else{d.push(getFieldData1(e))}break;case'CATEGORY':if(b[e.code]){c[b[e.code]]=getFieldData3(e)}else{d.push(getFieldData3(e))}break;case'REFERENCE_TABLE':break;case'CHECK_BOX':case'DROP_DOWN':case'RADIO_BUTTON':case'MULTI_SELECT':c[b[e.code]]=getFieldData4(e);break;default:break}}c=c.concat(d);return c}function getLayoutOrder(a){var b=[];var c=1;for(var i in a.layout){if(!a.layout.hasOwnProperty(i)){continue}var d=a.layout[i];if(d.type==='SUBTABLE'){for(var j in d.fields){if(!d.fields.hasOwnProperty(j)){continue}var e=d.fields[j].code;var f=d.fields[j].type;if(e&&f!=='REFERENCE_TABLE'){b[e]=c;c++}}}else if(d.type==='GROUP'){for(var l in d.layout){if(!d.layout.hasOwnProperty(l)){continue}var g=d.layout[l];for(var t in g.fields){if(!g.fields.hasOwnProperty(t)){continue}var h=g.fields[t].code;var m=g.fields[t].type;if(h&&m!=='REFERENCE_TABLE'){b[h]=c;c++}}}}else{for(var k in d.fields){if(!d.fields.hasOwnProperty(k)){continue}var n=d.fields[k].code;var o=d.fields[k].type;if(n&&o!=='REFERENCE_TABLE'){b[n]=c;c++}}}}return b}function getFormLayoutMap(){function getFormLayoutData(){var a={"app":kintone.app.getId()};return kintone.api(kintone.api.url("/k/v1/app/form/layout",true),"GET",a)}return getFormLayoutData().then(function(a){return getLayoutOrder(a)})}function getFormDesign(){function getFormData(){var a={"app":kintone.app.getId()};return kintone.api(kintone.api.url("/k/v1/app/form/fields",true),"GET",a)}getFormData().then(function(b){return getFormLayoutMap().then(function(a){return json2Csv(b,a)})}).then(function(a){var b=a.join(s);exportHTML(b);return b}).catch(function(e){console.log(e);alert(e.message)})}function createButton(a){if(!document.getElementById('form_output')){var b=document.createElement('button');b.id='form_output';b.innerText='設計情報の取得';b.style.marginRight='20px';a.appendChild(b);document.getElementById('form_output').addEventListener('click',getFormDesign,false)}}function showButton(a){var b=kintone.app.record.getHeaderMenuSpaceElement();createButton(b)}function showButton2(a){var b=kintone.app.getHeaderMenuSpaceElement();createButton(b)}kintone.events.on(['app.record.detail.show'],showButton);kintone.events.on(['app.record.index.show'],showButton2)})();